---
title: "SEPTA --- Study 1"
author: 
  - name: Andrea Discacciati
date: now
date-format: YYYY-MM-DD HH:mm
published-title: "Report compiled"
format:
  html:
    theme: default
    toc: true
    number-sections: true
    self-contained: true
    fontsize: medium
    anchor-sections: true
    toc-location: body
    grid:
      sidebar-width: 0px
      body-width: 1400px
      margin-width: 0px
      gutter-width: 0rem
execute:
  echo: false
editor_options: 
  chunk_output_type: console
params:
  save_tables: "false"
  time: "xxx"
---

```{r, include=FALSE}
source(here::here("rscripts", "analysis", "01-packages.R"))
source(here::here("rscripts", "analysis", "02-functions.R"))

#datetime_load <- "20230907_1201"
#latest dataset picked automatically
datetime_load <- tail(str_extract(sort(list.files(here::here("data", "derived"))), 
                                  "\\d{8}_\\d{4}"), 1)
datetime_load
septa <- readRDS(here::here("data", "derived", paste0(datetime_load, "-septa.rds"))) |> 
  make_test_pca_vars() |> 
  make_alternative_pca_vars()

septa_with_overall <- bind_rows(
  septa,
  septa |> mutate(race = "Overall")
) |> 
  mutate(race = factor(race, levels = c("Overall", levels(septa$race)))) 

tables_list <- vector(mode = "list")
```

Derived data time stamp: ``r format(attr(septa, "datetime_created"), usetz = TRUE)``.

# Table 1
```{r}
tables_list$table_1 <- septa |>
  make_table1_vars() |> 
  select(race, race_copy, age, psa, risk_score, dre_abnormal, fhpca, prevbx, five_ari, 
         risk_score, targeted_biopsy_performed, pirads3p, pirads4p, piradsns, 
         cb_benign, cb_isup1, cb_isup2p, al_isup2p, cb_isup3p) |> 
  tbl_summary(by = race,
              missing = "ifany",
              missing_text = "Missing",
              #type = all_dichotomous() ~ "categorical",
              digits = list(psa ~ 1)) |>  
  add_overall() |> 
  as_gt() |> 
  tab_options(table.font.size = px(14))

tables_list$table_1
```

```{r}
bloodtests <- c(`All` = "all", 
                `PSA>=3` = "psa_3p", 
                `PSA>=4` = "psa_4p", 
                `Stockholm3>=11`= "s3_11p", 
                `Stockholm3>=15` = "s3_15p")

bloodtests_table_2       <- bloodtests[c("PSA>=4", "Stockholm3>=15")]
bloodtests_table_2_11vs3 <- bloodtests[c("PSA>=3", "Stockholm3>=11")]
bloodtests_table_2_15vs3 <- bloodtests[c("PSA>=3", "Stockholm3>=15")]
```


# Table 2
relative Sensitivity, relative Specificity.

```{r}
table_2 <- split(septa_with_overall, septa_with_overall$race) |> 
  map(\(x) make_table_2(x, 
                        d = "cb_isup2p",
                        y1 = bloodtests_table_2[1], 
                        y2 = bloodtests_table_2[2], 
                        testlabels = names(bloodtests_table_2))) 

tables_list$table_2 <- table_2 |> 
  map(`[[`, "out_df") |> 
  bind_rows(.id = "race") |> 
  gt_table_2()

tables_list$table_2
```

```{r}
contrast_matrix <- matrix(c(1, -1,  0,  0, 
                            1,  0, -1,  0, 
                            1,  0,  0, -1), 
                          ncol = 4, 
                          byrow = TRUE)

log.rel.sens_race <- log(sapply(table_2, `[[`, c("result", "sensitivity", "rel.sens")))[levels(septa$race)]
se.log.rel.sens_race  <- sapply(table_2, `[[`, c("result", "sensitivity", "se.log.rel.sens"))[levels(septa$race)]
chi2.rel.sens_race <- aod::wald.test(Sigma = diag(se.log.rel.sens_race^2), 
                                     b = log.rel.sens_race, 
                                     L = contrast_matrix)

log.rel.spec_race <- log(sapply(table_2, `[[`, c("result", "specificity", "rel.spec")))[levels(septa$race)]
se.log.rel.spec_race  <- sapply(table_2, `[[`, c("result", "specificity", "se.log.rel.spec"))[levels(septa$race)]
chi2.rel.spec_race <- aod::wald.test(Sigma = diag(se.log.rel.spec_race^2), 
                                     b = log.rel.spec_race, 
                                     L = contrast_matrix)
```

P-value for heterogeneity (relative Sensitivity): `r format.pval(chi2.rel.sens_race$result$chi2["P"], digits = 2)` [ We had no evidence to reject the null hypothesis that relative Sensitivity was equal for the four race groups. / We had no evidence to conclude that relative Sensitivity was different across the four race groups. ] 

P-value for heterogeneity (relative Specificity): `r format.pval(chi2.rel.spec_race$result$chi2["P"], digits = 2)` [ We had evidence to reject the null hypothesis that relative Specificity was equal for the four race groups. / We had evidence to conclude that relative Specificity was different across the four race groups. ]


# Table 3
Sensitivity, Specificity, PPV, NPV.

```{r}
table_3 <- split(septa_with_overall, septa_with_overall$race) |> 
  map(\(x)
      imap(bloodtests, 
           \(y, tl) make_row_table_3(dat = x, d = "cb_isup2p", y = y, testlabel = tl)
      )
  )

tables_list$table_3 <- table_3 |> 
  map(
    \(r) map(r, `[[`, "out_df") |> bind_rows()
  ) |> 
  bind_rows(.id = "race") |> 
  gt_table_3()

tables_list$table_3
```




# Figure 1
```{r}
#| fig-width: 8
#| fig-height: 7

data_panel_rel.sens <- data.frame(
  race = names(table_2),
  rel = sapply(table_2, \(x) unname(x[["result"]][["sensitivity"]]["rel.sens"])),
  lcl.rel = sapply(table_2, \(x) unname(x[["result"]][["sensitivity"]]["lcl.rel.sens"])),
  ucl.rel = sapply(table_2, \(x) unname(x[["result"]][["sensitivity"]]["ucl.rel.sens"]))
) |> 
  mutate(race = factor(race, levels = rev(levels(septa_with_overall$race))))

panel_rel.sens <- plot_figure_1(dat = data_panel_rel.sens,
                                title = "Relative Sensitivity (95% CI)",
                                panel = "rsens") +
  geom_vline(xintercept = 0.8, lty = 2)


data_panel_rel.spec <- data.frame(
  race = names(table_2),
  rel = sapply(table_2, \(x) unname(x[["result"]][["specificity"]]["rel.spec"])),
  lcl.rel = sapply(table_2, \(x) unname(x[["result"]][["specificity"]]["lcl.rel.spec"])),
  ucl.rel = sapply(table_2, \(x) unname(x[["result"]][["specificity"]]["ucl.rel.spec"]))
) |> 
  mutate(race = factor(race, levels = rev(levels(septa_with_overall$race))))

panel_rel.spec <- plot_figure_1(dat = data_panel_rel.spec,
                                title = "Relative Specificity (95% CI)",
                                panel = "rspec")

patchwork::wrap_plots(panel_rel.sens,
                      patchwork::plot_spacer(),
                      panel_rel.spec,
                      patchwork::plot_spacer(),
                      nrow = 4,
                      heights = c(4, 1, 4, 1))
```


# Subgroup analyses

## Table 2
```{r}
septa_strata <- make_strata_vars(septa)
strata_vars <- names(septa_strata)[startsWith(names(septa_strata), "strata_")]
strata_vars <- setNames(strata_vars, labelled::var_label(septa_strata[, strata_vars]))

table_2_sa <- map(strata_vars, \(s)
                  map(split(septa_strata, septa_strata[[s]]), \(dat)
                      make_table_2(dat, 
                                   d = "cb_isup2p",
                                   y1 = bloodtests_table_2[1], 
                                   y2 = bloodtests_table_2[2], 
                                   testlabels = names(bloodtests_table_2))$out_df   
                  ) |> bind_rows(.id = "stratum")
) |> bind_rows(.id = "sa")

tables_list$table_2_sa <- table_2_sa |> 
  gt_table_2()

tables_list$table_2_sa
```

## Table 3

```{r}
table_3_sa <- map(
  strata_vars, \(s)
  map(split(septa_strata, septa_strata[[s]]), \(dat)
      imap(bloodtests, 
           \(y, tl) make_row_table_3(dat = dat, d = "cb_isup2p", y = y, testlabel = tl)$out_df
      ) |> bind_rows()
  ) |> bind_rows(.id = "stratum")
) |> bind_rows(.id = "sa")

tables_list$table_3_sa <- table_3_sa |> 
  gt_table_3()

tables_list$table_3_sa
```

# AUC

```{r}
septa_roc <- septa_with_overall |> 
  pivot_longer(cols = c(psa, risk_score)) |> 
  mutate(text = ifelse(name == "psa", "PSA (ng/ml)", "Stockholm3"))
```


## Combined biopsy

Outcome: ISUP2+ on combined biopsy (SBx+TBx)

```{r message = FALSE, warning = FALSE}
auc_roc_test <- make_table_auc(septa_roc, "cb_isup2p")

tables_list$auc_roc_test <- auc_roc_test |> 
  gt_table_auc()

tables_list$auc_roc_test
```

## Combined biopsy, alternative outcome definition

Outcome: unfavourable intermediate or higher cancers

```{r message = FALSE, warning = FALSE}
auc_roc_test_iu <- make_table_auc(septa_roc, "al_isup2p")

tables_list$auc_roc_test_iu <- auc_roc_test_iu |> 
  gt_table_auc()

tables_list$auc_roc_test_iu
```

## Standard biopsy in men without targeted biopses

Outcome: ISUP2+ on standard biopsy  

```{r message = FALSE, warning = FALSE}
auc_roc_test_notb <- make_table_auc(filter(septa_roc, targeted_biopsy_performed == "No"), "sb_isup2p")

auc_roc_test_notb |> 
  gt_table_auc()
```

# ROC curves

## Combined biopsy

Outcome: ISUP2+ on combined biopsy (SBx+TBx)

```{r}
#| fig-width: 12
#| fig-height: 10

roc_plots <- plot_roc_curves(cb_isup2p, septa_roc, auc_roc_test) +
  labs(title = "ROC curves for the Stockholm3 test and PSA (ng/ml) (ISUP>=2 cancers)")

roc_plots
```


## Combined biopsy, alternative outcome definition

Outcome: unfavourable intermediate or higher cancers

```{r}
#| fig-width: 12
#| fig-height: 10

roc_plots_iu <- plot_roc_curves(al_isup2p, septa_roc, auc_roc_test_iu) +
  labs(title = "ROC curves for the Stockholm3 test and PSA (ng/ml) (Unfavourable Intermediate or higher cancers)")

roc_plots_iu
```

## Standard biopsy in men without targeted biopses

Outcome: ISUP2+ on standard biopsy  

```{r}
#| fig-width: 12
#| fig-height: 10

roc_plots_notb <- plot_roc_curves(sb_isup2p, septa_roc, auc_roc_test_notb) +
  labs(title = "ROC curves for the Stockholm3 test and PSA (ng/ml) (ISUP>=2 cancers in men without targeted biopsies)")

roc_plots_notb
```


# Calibration curves

## Combined biopsy

Outcome: ISUP2+ on combined biopsy (SBx+TBx)

```{r}
#| fig-width: 12
#| fig-height: 10

calibration_plots <- imap(split(septa_with_overall, septa_with_overall$race),
                          \(x, y)   plot_calibration_curves(y = cb_isup2p,
                                                            p = (risk_score/100), # from S3M score to probability
                                                            data = x,
                                                            xlab = "Predicted ISUP >=2 probability",
                                                            ylab = "Observed ISUP >=2 probability",
                                                            title = y)$plot$lowess)

patchwork::wrap_plots(calibration_plots, nrow = 2) +
  patchwork::plot_annotation(
    title = "Calibration plots for the Stockholm3 test (ISUP>=2 cancers)"
  )
```

## Combined biopsy, alternative outcome definition

Outcome: unfavourable intermediate or higher cancers

```{r}
#| fig-width: 12
#| fig-height: 10

calibration_plots_iu <- imap(split(septa_with_overall, septa_with_overall$race),
                             \(x, y)   plot_calibration_curves(y = al_isup2p,
                                                               p = (risk_score/100), # from S3M score to probability
                                                               data = x,
                                                               xlab = "Predicted Unfav. Interm. or higher probability",
                                                               ylab = "Observed Unfav. Interm. or higher probability",
                                                               title = y)$plot$lowess)

patchwork::wrap_plots(calibration_plots_iu, nrow = 2) +
  patchwork::plot_annotation(
    title = "Calibration plots for the Stockholm3 test (Unfavourable Intermediate or higher cancers)"
  )
```


## Standard biopsy in men without targeted biopses

Outcome: ISUP2+ on standard biopsy  

```{r}
#| fig-width: 12
#| fig-height: 10
septa_with_overall_notb <- filter(septa_with_overall, 
                                  targeted_biopsy_performed == "No")

calibration_plots_notb <- imap(split(septa_with_overall_notb, septa_with_overall_notb$race),
                               \(x, y)   plot_calibration_curves(y = sb_isup2p,
                                                                 p = (risk_score/100), # from S3M score to probability
                                                                 data = x,
                                                                 xlab = "Predicted ISUP >=2 probability",
                                                                 ylab = "Observed ISUP >=2 probability",
                                                                 title = y)$plot$lowess)

patchwork::wrap_plots(calibration_plots_notb, nrow = 2) +
  patchwork::plot_annotation(
    title = "Calibration plots for the Stockholm3 test (in men without targeted biopsies)"
  )
```

# Decision curves

Outcome: ISUP2+ on combined biopsy (SBx+TBx)

```{r warning=FALSE, message=FALSE}
#| fig-width: 12
#| fig-height: 10
dca_plots <- imap(split(septa_with_overall, septa_with_overall$race),
                  \(x, y) plot_dca(x, y))

patchwork::wrap_plots(dca_plots, nrow = 2) +
  patchwork::plot_annotation(
    title = "Decision curve analysis for the Stockholm3 test and PSA (ng/ml)"
  ) +
  patchwork::plot_layout(guides = 'collect') &
  theme(legend.position='bottom')
```


# Stockholm3 threshold and specificity at fixed sensitivity ≥90%

Outcome: ISUP2+ on combined biopsy (SBx+TBx) 

```{r}
tables_list$s3m_fixed_sens_90 <- map(
  split(septa_with_overall, septa_with_overall$race), calculate_s3m_threshold_at_fixed_sens
) |> bind_rows(.id = "race") |> 
  select(-FPF) |> 
  mutate(across(c(TPF, TNF), format_percent)) |> 
  gt() |> 
  cols_label(
    race = "Race",
    TNF = "Specificity",
    TPF = "Sensitivity",
    c = "Stockholm3 threshold (>=)"
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(cells_column_labels(),
                     cells_column_spanners())
  ) |> 
  tab_options(table.font.size = px(14))

tables_list$s3m_fixed_sens_90
```



# Table year/recruitment/targeted biopsy

```{r}
tables_list$table_year_recruitment_tbx <- full_join(
  septa_strata |> 
    count(biopsy_year, strata_septa, .drop = FALSE) |> 
    pivot_wider(names_from = "strata_septa", values_from = "n",names_prefix = "septa_"),
  septa_strata |> 
    count(biopsy_year, targeted_biopsy_performed, .drop = FALSE) |> 
    pivot_wider(names_from = "targeted_biopsy_performed", values_from = "n", names_prefix = "tbx_") |> 
    select(biopsy_year, tbx_Yes),
  by = "biopsy_year"
) |> 
  mutate(Total = septa_No + septa_Yes,
         septa_Yes = paste0(septa_Yes, " (", format_percent(septa_Yes/Total), ")"),
         septa_No  = paste0(septa_No,  " (", format_percent(septa_No/Total),  ")"),
         tbx_Yes   = paste0(tbx_Yes,   " (", format_percent(tbx_Yes/Total),   ")")) |> 
  gt() |> 
  cols_label(
    biopsy_year = "Year of biopsy",
    septa_No = "No, n (%)",
    septa_Yes = "Yes, n (%)",
    tbx_Yes = "MRI-Targeted biopsies performed, n (%)",
    Total = "Total, n"
  ) |> 
  tab_spanner(
    label = "Men specifically recruited for SEPTA", columns = c("septa_No", "septa_Yes")
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(cells_column_labels(),
                     cells_column_spanners())
  ) |> 
  tab_options(table.font.size = px(14))

tables_list$table_year_recruitment_tbx
```

# Cancers missed/detected by race and blood test

```{r}
cancers_missed_detected <- septa_with_overall |> 
  pivot_longer(cols = unname(bloodtests[-1])) |> 
  select(name, value, combined_grade_group, race) |> 
  mutate(value = factor(value, labels = make_factor_labels()$ny),
         name = factor(name, levels = bloodtests[-1],
                       labels = names(bloodtests[-1]))) |> 
  split(~ race) |> 
  imap(
    \(s, n) tbl_strata(
      select(s, -race),
      strata = name,
      .tbl_fun =
        \(x) tbl_summary(x, by = value,
                         label = list(combined_grade_group ~ "Combined biopsy"),
                         all_categorical() ~ "{n}") |> 
        modify_header(label = paste0("**", n, "**")),
      .header = "**{strata}**"
    ) |> 
      as_gt() |> 
      tab_options(table.font.size = px(14))
  )
```

```{r results='asis'}
cancers_missed_detected
```

```{r}
names(cancers_missed_detected) <- paste0("cancers_missed_detected_", names(cancers_missed_detected))
tables_list <- c(tables_list, cancers_missed_detected)
```



# Alternative biopsy outcome definition


Cross-classification Combined biopsy GG versus Alternative biopsy outcome definition

```{r}
with(septa,
     addmargins(tablem(alternative_grade_group, combined_grade_group)))
```


## Table 2
```{r}
table_2_alt <- split(septa_with_overall, septa_with_overall$race) |> 
  map(\(x) make_table_2(x, 
                        d = "al_isup2p",
                        y1 = bloodtests_table_2[1], 
                        y2 = bloodtests_table_2[2], 
                        testlabels = names(bloodtests_table_2))) 

tables_list$table_2_alt <- table_2_alt |> 
  map(`[[`, "out_df") |> 
  bind_rows(.id = "race") |> 
  gt_table_2_alt()

tables_list$table_2_alt
```

## Table 3


```{r}
table_3_alt <- split(septa_with_overall, septa_with_overall$race) |> 
  map(\(x)
      imap(bloodtests, 
           \(y, tl) make_row_table_3(dat = x, 
                                     d = "al_isup2p", 
                                     y = y, 
                                     testlabel = tl)
      )
  )

tables_list$table_3_alt <- table_3_alt |> 
  map(
    \(r) map(r, `[[`, "out_df") |> bind_rows()
  ) |> 
  bind_rows(.id = "race") |> 
  gt_table_3_alt()

tables_list$table_3_alt
```

# Table 2 for Stockholm3≥11 vs PSA≥3 ng/ml

Outcome: ISUP2+ on combined biopsy (SBx+TBx)

```{r}

table_2_11vs3 <- split(septa_with_overall, septa_with_overall$race) |> 
  map(\(x) make_table_2(x, 
                        d = "cb_isup2p",
                        y1 = bloodtests_table_2_11vs3[1], 
                        y2 = bloodtests_table_2_11vs3[2], 
                        testlabels = names(bloodtests_table_2_11vs3))) 

tables_list$table_2_11vs3 <- table_2_11vs3 |> 
  map(`[[`, "out_df") |> 
  bind_rows(.id = "race") |> 
  gt_table_2()

tables_list$table_2_11vs3
```

# Table 2 for Stockholm3≥15 vs PSA≥3 ng/ml

Outcome: ISUP2+ on combined biopsy (SBx+TBx)

```{r}

table_2_15vs3 <- split(septa_with_overall, septa_with_overall$race) |> 
  map(\(x) make_table_2(x, 
                        d = "cb_isup2p",
                        y1 = bloodtests_table_2_15vs3[1], 
                        y2 = bloodtests_table_2_15vs3[2], 
                        testlabels = names(bloodtests_table_2_15vs3))) 

tables_list$table_2_15vs3 <- table_2_15vs3 |> 
  map(`[[`, "out_df") |> 
  bind_rows(.id = "race") |> 
  gt_table_2()

tables_list$table_2_15vs3
```

```{r}
if(params$save_tables == "true") {
  gt_group(.list = tables_list) |> 
    gtsave(here::here("output", paste0(params$time, "-septa_tables_study1.docx")))
}
```


# Session info

```{r}
sessionInfo()
```



